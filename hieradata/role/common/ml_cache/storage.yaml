cluster: ml_cache

profile::admin::groups:
  - ml-team-admins

profile::cassandra::allow_analytics: true

profile::java::java_packages:
  - version: '8'
    variant: 'jdk'

profile::cassandra::settings:
  start_rpc: false
  dc: "%{::site}"
  cluster_name: "ml_cache"
  tls_cluster_name: "ml_cache"
  tls_use_pki_truststore: true
  super_username: cassandra
  super_password: "%{passwords::cassandra::super_password}"
  target_version: '4.x'
  default_instance_params:
    max_heap_size: 12g
    # 1/4 heap size, no more than 100m/thread
    heap_newsize: 2048m
    compaction_throughput_mb_per_sec: 20
    concurrent_compactors: 10
    concurrent_writes: 18
    concurrent_reads: 18
    permissions_validity_in_ms: 600000
    trickle_fsync: false
    client_encryption_enabled: true
    client_encryption_optional: true
    internode_encryption: all
    server_encryption_optional: true
    legacy_ssl_storage_port_enabled: true

profile::contacts::role_contacts: ["Machine Learning"]

# Temporary override to allow the creation of a bundle
# that includes the custom CA certificate that Cassandra nodes use.
# TODO: remove the trusted_certs setting after the cluster
# is migrated to PKI.
profile::base::certificates::include_bundle_jks: true
profile::base::certificates::trusted_certs:
  package: 'wmf-certificates'
  bundle: '/etc/ssl/certs/wmf-ca-certificates.crt'
  certs:
  - '/usr/share/ca-certificates/wikimedia/Puppet_Internal_CA.crt'
  - '/usr/share/ca-certificates/wikimedia/Wikimedia_Internal_Root_CA.crt'
  - '/etc/cassandra-a/tls/rootCa.crt'